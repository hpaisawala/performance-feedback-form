<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Test Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-2xl font-bold mb-6">Google Sheets Test Form</h1>
        
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
            <h3 class="font-bold mb-2">Setup Instructions:</h3>
            <ol class="list-decimal list-inside space-y-1 text-sm">
                <li>Create a new Google Sheet</li>
                <li>Copy the Spreadsheet ID from the URL</li>
                <li>Paste the ID in the input below</li>
                <li>Use the Apps Script code provided below</li>
                <li>Deploy and paste the Web App URL</li>
            </ol>
        </div>

        <div class="space-y-4 mb-6">
            <div>
                <label class="block font-semibold mb-2">Spreadsheet ID:</label>
                <input type="text" id="spreadsheetId" class="w-full p-2 border rounded" placeholder="Paste your spreadsheet ID here">
                <p class="text-xs text-gray-500 mt-1">Found in URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</p>
            </div>
            
            <div>
                <label class="block font-semibold mb-2">Web App URL:</label>
                <input type="text" id="webAppUrl" class="w-full p-2 border rounded" placeholder="Paste your deployed web app URL here">
                <p class="text-xs text-gray-500 mt-1">Should end with /exec</p>
            </div>
        </div>

        <form id="testForm" class="space-y-4 mb-6">
            <div>
                <label class="block font-semibold mb-2">Test Name:</label>
                <input type="text" name="testName" required class="w-full p-2 border rounded" placeholder="Enter any name">
            </div>
            
            <div>
                <label class="block font-semibold mb-2">Test Email:</label>
                <input type="email" name="testEmail" required class="w-full p-2 border rounded" placeholder="Enter any email">
            </div>
            
            <div>
                <label class="block font-semibold mb-2">Test Number:</label>
                <input type="number" name="testNumber" required class="w-full p-2 border rounded" placeholder="Enter any number">
            </div>
            
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded">
                Submit Test
            </button>
        </form>

        <div id="status" class="hidden p-4 rounded mb-6"></div>
        
        <div id="logs" class="bg-gray-50 p-4 rounded border">
            <h3 class="font-bold mb-2">Debug Logs:</h3>
            <div id="logContent" class="text-xs font-mono space-y-1 text-gray-700"></div>
        </div>

        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <h3 class="font-bold mb-2">Google Apps Script Code:</h3>
            <pre class="text-xs bg-white p-3 rounded border overflow-x-auto"><code>function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);
  
  try {
    Logger.log('POST received');
    
    // Get spreadsheet by ID from parameter
    var sheetId = e.parameter.spreadsheetId;
    var ss = SpreadsheetApp.openById(sheetId);
    var sheet = ss.getSheets()[0];
    
    // Add headers if first row is empty
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Timestamp', 'Name', 'Email', 'Number']);
    }
    
    // Append data
    sheet.appendRow([
      new Date(),
      e.parameter.testName || '',
      e.parameter.testEmail || '',
      e.parameter.testNumber || ''
    ]);
    
    Logger.log('Data saved successfully');
    
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'success',
        message: 'Data saved',
        row: sheet.getLastRow()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    Logger.log('Error: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function doGet() {
  return HtmlService.createHtmlOutput('Script is deployed correctly!');
}</code></pre>
        </div>
    </div>

    <script>
        const form = document.getElementById('testForm');
        const statusDiv = document.getElementById('status');
        const logContent = document.getElementById('logContent');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700';
            logContent.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function showStatus(message, isError = false) {
            statusDiv.className = `p-4 rounded mb-6 ${isError ? 'bg-red-50 border border-red-200 text-red-700' : 'bg-green-50 border border-green-200 text-green-700'}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            
            if (!spreadsheetId || !webAppUrl) {
                showStatus('Please enter both Spreadsheet ID and Web App URL', true);
                addLog('Missing Spreadsheet ID or Web App URL', 'error');
                return;
            }
            
            addLog('Starting submission...');
            addLog(`Target URL: ${webAppUrl}`);
            addLog(`Spreadsheet ID: ${spreadsheetId}`);
            
            const formData = new FormData(form);
            formData.append('spreadsheetId', spreadsheetId);
            
            // Log form data
            addLog('Form data:');
            for (let [key, value] of formData.entries()) {
                addLog(`  ${key}: ${value}`);
            }
            
            try {
                addLog('Sending POST request...');
                
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });
                
                addLog(`Response status: ${response.status}`, 'success');
                addLog(`Response type: ${response.type}`, 'success');
                
                const text = await response.text();
                addLog(`Response body: ${text}`, 'success');
                
                try {
                    const json = JSON.parse(text);
                    if (json.status === 'success') {
                        showStatus(`✓ Success! Data saved to row ${json.row}`);
                        addLog('✓ Data successfully saved to Google Sheet!', 'success');
                        form.reset();
                    } else {
                        showStatus(`Error: ${json.message}`, true);
                        addLog(`Error from script: ${json.message}`, 'error');
                    }
                } catch {
                    showStatus('Form submitted (check your sheet)', false);
                    addLog('Response received (not JSON, check sheet manually)', 'success');
                }
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, true);
                addLog(`Fetch error: ${error.message}`, 'error');
                addLog(`Error details: ${error.toString()}`, 'error');
            }
        });

        addLog('Test form loaded and ready');
        addLog('Fill in your Spreadsheet ID and Web App URL above to begin');
    </script>
</body>
</html>
